import { NextRequest, NextResponse } from 'next/server'
import { createClient, createAdminClient } from '@/lib/supabase/server'
import { getUserFromSession } from '@/lib/session-utils'

export const dynamic = 'force-dynamic'

// Системные промпты для разных инструкторов
const INSTRUCTOR_PROMPTS: Record<string, string> = {
  anna: `Ты Анна Здоровьева - эксперт по кето-диете и метаболическому здоровью. Твоя специализация:

- Расчет макросов (БЖУ) для кето-диеты
- Рецепты и планирование кето-меню
- Вход в кетоз и адаптация
- Решение проблем кето-гриппа
- Электролитный баланс
- Кето в ресторанах и путешествиях
- Преодоление плато

Твои принципы:
- Будь дружелюбной, поддерживающей и мотивирующей
- Давай конкретные, практичные советы по кето-диете
- Используй научно обоснованную информацию
- Помогай с расчетами и планированием
- Отвечай на русском языке
- Будь краткой, но информативной (до 300 слов)

Если вопрос не связан с кето-диетой, вежливо направь к своей специализации или предложи обратиться к другому инструктору.`,

  dmitry: `Ты Дмитрий Фастинг - специалист по интервальному голоданию и долголетию. Твоя специализация:

- Выбор протокола IF (16/8, 18/6, 20/4, OMAD)
- Настройка режима голодания
- Совмещение IF с тренировками
- Преодоление трудностей первых дней
- Автофагия и долголетие
- IF для женщин (особенности)
- Продвинутые протоколы

Твои принципы:
- Будь дружелюбным, поддерживающим и мотивирующим
- Делись личным опытом трансформации (похудел на 25 кг с помощью IF)
- Давай конкретные, практичные советы по интервальному голоданию
- Используй научно обоснованную информацию
- Помогай настроить индивидуальный режим
- Отвечай на русском языке
- Будь кратким, но информативным (до 300 слов)

Если вопрос не связан с интервальным голоданием, вежливо направь к своей специализации или предложи обратиться к другому инструктору.`,

  general: `Ты общий инструктор по здоровью и питанию. Твоя специализация:

- Общие вопросы по здоровому образу жизни
- Баланс питания и физической активности
- Мотивация и поддержка
- Общие принципы здорового питания
- Вопросы, не связанные с конкретной диетой

Твои принципы:
- Будь дружелюбным, поддерживающим и мотивирующим
- Давай конкретные, практичные советы
- Используй научно обоснованную информацию
- Если вопрос специфичен для кето или IF, направь к соответствующему специалисту
- Отвечай на русском языке
- Будь кратким, но информативным (до 300 слов)

Если вопрос лучше подходит для специализированного инструктора, вежливо предложи обратиться к Анне (кето) или Дмитрию (IF).`
}

export async function POST(request: NextRequest) {
  try {
    const supabase = await createClient()
    const user = await getUserFromSession(supabase)

    if (!user) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      )
    }

    // Проверяем, что пользователь купил хотя бы один курс
    const accessResponse = await fetch(
      `${request.nextUrl.origin}/api/courses/access?check_purchased=true`,
      {
        headers: {
          Cookie: request.headers.get('Cookie') || '',
        },
      }
    )

    const accessData = await accessResponse.json()
    if (!accessData.hasPurchased) {
      return NextResponse.json(
        { error: 'Access denied. You need to purchase at least one course.' },
        { status: 403 }
      )
    }

    const { message, instructorId, conversationHistory } = await request.json()

    if (!message || typeof message !== 'string') {
      return NextResponse.json(
        { error: 'Message is required' },
        { status: 400 }
      )
    }

    const instructorPrompt = INSTRUCTOR_PROMPTS[instructorId || 'general'] || INSTRUCTOR_PROMPTS.general

    // TODO: Интеграция с OpenAI API
    // Для начала используем простой ответ, пока не настроен OpenAI
    // В production нужно добавить:
    // 1. Установить пакет: npm install openai
    // 2. Добавить OPENAI_API_KEY в .env
    // 3. Раскомментировать код ниже и удалить временный ответ

    /*
    const OpenAI = require('openai')
    const openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY,
    })

    const messages = [
      { role: 'system', content: instructorPrompt },
      ...conversationHistory.map((msg: any) => ({
        role: msg.role === 'user' ? 'user' : 'assistant',
        content: msg.content
      })),
      { role: 'user', content: message }
    ]

    const completion = await openai.chat.completions.create({
      model: 'gpt-4o-mini', // или 'gpt-3.5-turbo' для экономии
      messages: messages,
      temperature: 0.7,
      max_tokens: 500,
    })

    const response = completion.choices[0]?.message?.content || 'Извините, не удалось получить ответ.'
    */

    // Временный ответ (заменить на реальный AI)
    const response = generateTemporaryResponse(message, instructorId || 'general')

    return NextResponse.json({ response })
  } catch (error: any) {
    console.error('Instructor chat API error:', error)
    return NextResponse.json(
      { error: error.message || 'Internal server error' },
      { status: 500 }
    )
  }
}

// Временная функция для генерации ответов (заменить на реальный AI)
function generateTemporaryResponse(message: string, instructorId: string): string {
  const lowerMessage = message.toLowerCase()

  // Ответы от Анны (кето-диета)
  if (instructorId === 'anna') {
    if (lowerMessage.includes('макрос') || lowerMessage.includes('бжу') || lowerMessage.includes('калори')) {
      return `Для расчета макросов на кето-диете используйте следующую формулу:

**Базовые рекомендации:**
- **Углеводы**: 20-50г в день (5-10% калорий)
- **Белки**: 1.2-2г на кг веса (20-25% калорий)
- **Жиры**: Остальное (70-80% калорий)

**Пример для человека 70кг, цель 2000 ккал:**
- Углеводы: 25г (100 ккал)
- Белки: 105г (420 ккал)
- Жиры: 164г (1480 ккал)

В нашем курсе есть калькулятор макросов, который рассчитает всё автоматически с учетом ваших параметров!

Есть ли конкретные вопросы по расчету?`
    }

    if (lowerMessage.includes('рецепт') || lowerMessage.includes('блюд') || lowerMessage.includes('готовить')) {
      return `Отлично! В нашем курсе более 100 кето-рецептов с подробными инструкциями.

**Основные принципы кето-готовки:**
- Используйте полезные жиры (авокадо, оливковое масло, кокосовое масло)
- Выбирайте низкоуглеводные овощи (шпинат, брокколи, цветная капуста)
- Включайте качественные белки (яйца, рыба, мясо)
- Избегайте сахара и крахмала

В генераторе меню вы найдете рецепты на завтрак, обед, ужин, перекусы и десерты. Все рецепты содержат КБЖУ и пошаговые инструкции.

Какое блюдо вас интересует?`
    }

    if (lowerMessage.includes('кетоз') || lowerMessage.includes('войти') || lowerMessage.includes('начать')) {
      return `Вход в кетоз - важный этап! Вот основные шаги:

**Первая неделя:**
1. Ограничьте углеводы до 20-25г в день
2. Увеличьте потребление жиров до 70-80% калорий
3. Пейте много воды (2-3 литра)
4. Добавляйте соль в воду (1/2 ч.л. на литр)

**Важно для предотвращения кето-гриппа:**
- Электролиты: натрий, калий, магний
- Достаточное количество жиров
- Не переедайте белок

**Признаки входа в кетоз:**
- Устойчивая энергия
- Снижение аппетита
- Ясность ума
- Легкий запах ацетона (опционально)

Обычно кетоз наступает через 2-4 дня. Есть ли конкретные вопросы?`
    }

    return `Привет! Я Анна, ваш эксперт по кето-диете. Я помогу вам с:

- Расчетом макросов
- Рецептами и планированием меню
- Входом в кетоз
- Решением проблем

Задайте вопрос, и я с радостью помогу!`
  }

  // Ответы от Дмитрия (интервальное голодание)
  if (instructorId === 'dmitry') {
    if (lowerMessage.includes('протокол') || lowerMessage.includes('16/8') || lowerMessage.includes('18/6') || lowerMessage.includes('выбрать')) {
      return `Отличный вопрос! Выбор протокола зависит от вашего опыта и целей:

**Для новичков:**
- **16/8**: 16 часов голода, 8 часов окно питания
  - Начните с 14/10, постепенно увеличивайте до 16/8
  - Идеально для начала

**Для продвинутых:**
- **18/6**: 18 часов голода, 6 часов окно питания
- **20/4 (OMAD)**: Один прием пищи в день
- **24 часа**: Раз в неделю

**Мой совет:** Начните с 16/8. Это самый комфортный и эффективный протокол для большинства людей.

Какой протокол вас интересует?`
    }

    if (lowerMessage.includes('голод') || lowerMessage.includes('трудно') || lowerMessage.includes('сложно')) {
      return `Понимаю! Первые дни могут быть непростыми. Вот что помогает:

**Стратегии преодоления голода:**
1. **Вода**: Пейте много воды (2-3 литра)
2. **Чай/кофе**: Без сахара и молока (можно добавить щепотку соли)
3. **Отвлечение**: Займитесь делом, прогуляйтесь
4. **Постепенность**: Начните с 12/12, затем увеличивайте

**Важно:** Настоящий голод vs. скука/привычка - это разные вещи! Научитесь различать.

**Мой опыт:** Первые 2 недели самые сложные. Если пройдете их - вы уже победили! После этого голод становится управляемым.

Какой день у вас? Могу дать более конкретные советы!`
    }

    if (lowerMessage.includes('тренировк') || lowerMessage.includes('спорт') || lowerMessage.includes('фитнес')) {
      return `Отличный вопрос! IF и тренировки отлично сочетаются:

**Рекомендации:**
- **Тренировки натощак**: Более эффективны для жиросжигания
- **Время**: Лучше тренироваться в конце периода голодания
- **Интенсивность**: Начните с легких тренировок, постепенно увеличивайте

**После тренировки:**
- Можно сразу поесть (открыть окно питания)
- Или продолжить голодание (если чувствуете себя хорошо)

**Мой опыт:** Я бегаю полумарафоны натощак! Это дает невероятную энергию и ясность ума.

Какой вид тренировок вас интересует?`
    }

    return `Привет! Я Дмитрий, специалист по интервальному голоданию. 5 лет назад я похудел на 25 кг с помощью IF!

Я помогу вам с:
- Выбором протокола IF
- Настройкой режима
- Преодолением трудностей
- Совмещением с тренировками

Задайте вопрос, и я поделюсь опытом!`
  }

  // Общие ответы (general instructor)
  if (instructorId === 'general') {
    if (lowerMessage.includes('кето') || lowerMessage.includes('кетогенн')) {
      return `Вопросы по кето-диете лучше задать Анне Здоровьевой - она специализируется именно на этом. Она поможет с расчетом макросов, рецептами и адаптацией к кетозу.

Хотите переключиться на Анну или у вас общий вопрос?`
    }

    if (lowerMessage.includes('голодание') || lowerMessage.includes('интервал') || lowerMessage.includes('if')) {
      return `Вопросы по интервальному голоданию лучше задать Дмитрию Фастингу - он специализируется на IF и имеет личный опыт трансформации (похудел на 25 кг).

Хотите переключиться на Дмитрия или у вас общий вопрос?`
    }

    if (lowerMessage.includes('привет') || lowerMessage.includes('здравствуй')) {
      return `Привет! Я ваш общий инструктор по здоровью и питанию.

Я могу помочь с общими вопросами о здоровом образе жизни. Если у вас есть специфические вопросы по кето-диете или интервальному голоданию, рекомендую обратиться к специализированным инструкторам:
- Анна Здоровьева - кето-диета
- Дмитрий Фастинг - интервальное голодание

Чем могу помочь?`
    }

    return `Я ваш общий инструктор. Могу помочь с общими вопросами о здоровье и питании.

Для специфических вопросов рекомендую:
- **Анна Здоровьева** - кето-диета, расчет макросов, рецепты
- **Дмитрий Фастинг** - интервальное голодание, протоколы IF

Чем могу помочь?`
  }

  // Fallback для других случаев
  return `Спасибо за ваш вопрос! Я специализируюсь на кето-диете и интервальном голодании.

Могу помочь с:
- Планированием кето-меню
- Настройкой интервального голодания
- Вопросами о питании и здоровье
- Рецептами и готовкой

Уточните, пожалуйста, что именно вас интересует?`
}

