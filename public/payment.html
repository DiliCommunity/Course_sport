<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–ø–ª–∞—Ç–∞ –∫—É—Ä—Å–∞ - Course Health</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/js/supabase-client.js"></script>
    <style>
        .payment-page {
            min-height: 100vh;
            padding: 120px 0 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .payment-container {
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
        }
        
        .payment-card {
            background: linear-gradient(135deg, var(--glass), rgba(255, 255, 255, 0.05));
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 40px;
            backdrop-filter: blur(20px);
        }
        
        .payment-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .payment-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .payment-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-white);
            margin-bottom: 10px;
        }
        
        .payment-course-name {
            color: var(--accent-electric);
            font-size: 18px;
            font-weight: 600;
        }
        
        /* –ë–ª–æ–∫ —Å —Ü–µ–Ω–æ–π */
        .payment-price-box {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(0, 217, 255, 0.15));
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .payment-price-label {
            color: var(--text-gray);
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .payment-price {
            font-size: 48px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-electric));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .payment-price-test {
            display: inline-block;
            background: var(--accent-flame);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            margin-top: 10px;
        }
        
        /* –ú–µ—Ç–æ–¥—ã –æ–ø–ª–∞—Ç—ã */
        .payment-methods {
            margin-bottom: 30px;
        }
        
        .payment-methods-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-white);
            margin-bottom: 15px;
        }
        
        .payment-method {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .payment-method:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--glass-border);
        }
        
        .payment-method.selected {
            background: rgba(0, 217, 255, 0.1);
            border-color: var(--accent-electric);
        }
        
        .payment-method-icon {
            width: 48px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .payment-method-icon img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .payment-method-info {
            flex: 1;
        }
        
        .payment-method-name {
            font-weight: 600;
            color: var(--text-white);
            font-size: 15px;
        }
        
        .payment-method-desc {
            font-size: 12px;
            color: var(--text-gray);
            margin-top: 2px;
        }
        
        .payment-method-check {
            width: 24px;
            height: 24px;
            border: 2px solid var(--glass-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .payment-method.selected .payment-method-check {
            background: var(--accent-electric);
            border-color: var(--accent-electric);
        }
        
        .payment-method.selected .payment-method-check::after {
            content: '‚úì';
            color: var(--bg-dark);
            font-weight: bold;
            font-size: 14px;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –æ–ø–ª–∞—Ç—ã */
        .payment-submit {
            width: 100%;
            padding: 18px 32px;
            font-size: 18px;
            font-weight: 700;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-electric));
            color: var(--bg-dark);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .payment-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.4);
        }
        
        .payment-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å */
        .payment-security {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .payment-security-icon {
            font-size: 24px;
        }
        
        .payment-security-text {
            font-size: 13px;
            color: var(--text-gray);
            line-height: 1.5;
        }
        
        .payment-security-text strong {
            color: var(--accent-neon);
        }
        
        /* –õ–æ–≥–æ—Ç–∏–ø—ã –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º */
        .payment-logos {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--glass-border);
        }
        
        .payment-logo {
            height: 24px;
            opacity: 0.7;
            transition: opacity 0.3s;
        }
        
        .payment-logo:hover {
            opacity: 1;
        }
        
        /* –°—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ */
        .payment-loading {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
        
        .payment-loading.active {
            display: flex;
        }
        
        .payment-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--glass-border);
            border-top-color: var(--accent-electric);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .payment-loading-text {
            margin-top: 20px;
            color: var(--text-gray);
            font-size: 16px;
        }
        
        /* –û—à–∏–±–∫–∞ */
        .payment-error {
            display: none;
            padding: 16px;
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid rgba(255, 107, 53, 0.3);
            border-radius: 12px;
            margin-bottom: 20px;
            color: var(--accent-flame);
            font-size: 14px;
        }
        
        .payment-error.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .payment-card {
                padding: 24px;
                margin: 0 16px;
            }
            
            .payment-price {
                font-size: 36px;
            }
            
            .payment-title {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="nav">
                <a href="/index.html" class="logo" style="text-decoration: none; color: inherit;">
                    <span class="logo-icon">üíö</span>
                    <span class="logo-text">Course Health</span>
                </a>
                <div class="nav-actions">
                    <a href="/courses.html" class="btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ –∫—É—Ä—Å–∞–º</a>
                </div>
            </nav>
        </div>
    </header>

    <!-- Payment Page -->
    <section class="payment-page">
        <div class="container">
            <div class="payment-container">
                <div class="payment-card">
                    <!-- –§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã -->
                    <div id="paymentForm">
                        <div class="payment-header">
                            <div class="payment-icon">üí≥</div>
                            <h1 class="payment-title">–û–ø–ª–∞—Ç–∞ –∫—É—Ä—Å–∞</h1>
                            <div class="payment-course-name" id="courseName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        </div>

                        <div class="payment-error" id="paymentError"></div>

                        <div class="payment-price-box">
                            <div class="payment-price-label">–ö –æ–ø–ª–∞—Ç–µ:</div>
                            <div class="payment-price" id="coursePrice">0 ‚ÇΩ</div>
                            <div class="payment-price-test">üß™ –¢–µ—Å—Ç–æ–≤–∞—è —Ü–µ–Ω–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
                        </div>

                        <div class="payment-methods">
                            <div class="payment-methods-title">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</div>
                            
                            <!-- –°–ë–ü -->
                            <div class="payment-method selected" data-method="sbp">
                                <div class="payment-method-icon">
                                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                                        <rect width="32" height="32" rx="6" fill="#1D1346"/>
                                        <path d="M16 6L8 10.5V21.5L16 26L24 21.5V10.5L16 6Z" fill="url(#sbp_grad)"/>
                                        <defs>
                                            <linearGradient id="sbp_grad" x1="8" y1="6" x2="24" y2="26">
                                                <stop stop-color="#5B57A2"/>
                                                <stop offset="0.5" stop-color="#D90E7A"/>
                                                <stop offset="1" stop-color="#FAA61A"/>
                                            </linearGradient>
                                        </defs>
                                    </svg>
                                </div>
                                <div class="payment-method-info">
                                    <div class="payment-method-name">–°–ë–ü</div>
                                    <div class="payment-method-desc">–°–∏—Å—Ç–µ–º–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π</div>
                                </div>
                                <div class="payment-method-check"></div>
                            </div>

                            <!-- –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞ -->
                            <div class="payment-method" data-method="card">
                                <div class="payment-method-icon">
                                    <svg width="32" height="24" viewBox="0 0 32 24" fill="none">
                                        <rect width="32" height="24" rx="4" fill="#1A1A2E"/>
                                        <rect x="0" y="6" width="32" height="4" fill="#FFD700"/>
                                        <rect x="4" y="14" width="12" height="2" rx="1" fill="#666"/>
                                        <rect x="4" y="18" width="8" height="2" rx="1" fill="#666"/>
                                        <circle cx="23" cy="12" r="4" fill="#EB001B"/>
                                        <circle cx="27" cy="12" r="4" fill="#F79E1B" fill-opacity="0.8"/>
                                    </svg>
                                </div>
                                <div class="payment-method-info">
                                    <div class="payment-method-name">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</div>
                                    <div class="payment-method-desc">Visa, Mastercard, –ú–ò–†</div>
                                </div>
                                <div class="payment-method-check"></div>
                            </div>

                            <!-- –°–±–µ—Ä–ü–µ–π -->
                            <div class="payment-method" data-method="sber_pay">
                                <div class="payment-method-icon">
                                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                                        <rect width="32" height="32" rx="8" fill="#21A038"/>
                                        <path d="M16 7C11.03 7 7 11.03 7 16C7 20.97 11.03 25 16 25C20.97 25 25 20.97 25 16" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                                        <path d="M16 7V16L22 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div class="payment-method-info">
                                    <div class="payment-method-name">–°–±–µ—Ä–ü–µ–π</div>
                                    <div class="payment-method-desc">–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –°–±–µ—Ä–±–∞–Ω–∫</div>
                                </div>
                                <div class="payment-method-check"></div>
                            </div>

                            <!-- –ÆMoney -->
                            <div class="payment-method" data-method="yoomoney">
                                <div class="payment-method-icon">
                                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                                        <rect width="32" height="32" rx="8" fill="#8B3FFD"/>
                                        <circle cx="12" cy="16" r="6" fill="white"/>
                                        <path d="M18 10L26 16L18 22V10Z" fill="white"/>
                                    </svg>
                                </div>
                                <div class="payment-method-info">
                                    <div class="payment-method-name">–ÆMoney</div>
                                    <div class="payment-method-desc">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∫–æ—à–µ–ª–µ–∫</div>
                                </div>
                                <div class="payment-method-check"></div>
                            </div>
                        </div>

                        <button class="payment-submit" id="payButton" onclick="processPayment()">
                            <span>–û–ø–ª–∞—Ç–∏—Ç—å</span>
                            <span id="payButtonPrice">0 ‚ÇΩ</span>
                        </button>

                        <div class="payment-security">
                            <div class="payment-security-icon">üîí</div>
                            <div class="payment-security-text">
                                <strong>–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–ø–ª–∞—Ç–∞</strong><br>
                                –ü–ª–∞—Ç–µ–∂ –∑–∞—â–∏—â–µ–Ω SSL-—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º. –ú—ã –Ω–µ —Ö—Ä–∞–Ω–∏–º –¥–∞–Ω–Ω—ã–µ –≤–∞—à–µ–π –∫–∞—Ä—Ç—ã.
                            </div>
                        </div>

                        <div class="payment-logos">
                            <span style="font-size: 12px; color: var(--text-gray);">–ü–ª–∞—Ç–µ–∂–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:</span>
                            <span style="font-weight: 700; color: var(--accent-electric);">–ÆKassa</span>
                        </div>
                    </div>

                    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
                    <div class="payment-loading" id="paymentLoading">
                        <div class="payment-spinner"></div>
                        <div class="payment-loading-text">–°–æ–∑–¥–∞–µ–º –ø–ª–∞—Ç–µ–∂...</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('course');
        const courseTitle = urlParams.get('title') || '–ö—É—Ä—Å';
        const coursePrice = parseInt(urlParams.get('price')) || 1000; // –¢–µ—Å—Ç–æ–≤–∞—è —Ü–µ–Ω–∞ 10‚ÇΩ = 1000 –∫–æ–ø–µ–µ–∫

        let selectedMethod = 'sbp';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫—É—Ä—Å–∞
            document.getElementById('courseName').textContent = decodeURIComponent(courseTitle);
            document.getElementById('coursePrice').textContent = formatPrice(coursePrice);
            document.getElementById('payButtonPrice').textContent = formatPrice(coursePrice);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', function() {
                    document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedMethod = this.dataset.method;
                });
            });
        });

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã
        function formatPrice(kopecks) {
            const rubles = kopecks / 100;
            return rubles.toLocaleString('ru-RU') + ' ‚ÇΩ';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            const errorEl = document.getElementById('paymentError');
            errorEl.textContent = message;
            errorEl.classList.add('active');
        }

        // –°–∫—Ä—ã—Ç—å –æ—à–∏–±–∫—É
        function hideError() {
            document.getElementById('paymentError').classList.remove('active');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        function showLoading() {
            document.getElementById('paymentForm').style.display = 'none';
            document.getElementById('paymentLoading').classList.add('active');
        }

        // –°–∫—Ä—ã—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        function hideLoading() {
            document.getElementById('paymentForm').style.display = 'block';
            document.getElementById('paymentLoading').classList.remove('active');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã
        async function processPayment() {
            hideError();
            showLoading();

            try {
                // –ü–æ–ª—É—á–∞–µ–º userId –∏–∑ localStorage (–µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω)
                const userId = localStorage.getItem('user_id') || null;

                const response = await fetch('/api/payments/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        courseId: courseId,
                        paymentMethod: selectedMethod,
                        amount: coursePrice,
                        userId: userId,
                        returnUrl: window.location.origin + '/payment-success.html?course=' + courseId
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞');
                }

                if (data.confirmationUrl) {
                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã –Æ–ö–∞—Å—Å–∞
                    window.location.href = data.confirmationUrl;
                } else {
                    throw new Error('–ù–µ –ø–æ–ª—É—á–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É');
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã:', error);
                hideLoading();
                showError(error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            }
        }
    </script>
</body>
</html>
