<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–µ—Ç–æ-—Ä–µ—Ü–µ–ø—Ç—ã: –≥–æ—Ç–æ–≤–∏–º –≤–∫—É—Å–Ω–æ - Course Health</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/course-page.css">
    <script src="/js/translations.js"></script>
    <script src="/js/language.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/js/telegram-webapp.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="nav">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button class="burger-menu" id="burgerMenu" aria-label="–ú–µ–Ω—é">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    <a href="/index.html" class="logo" style="text-decoration: none; color: inherit;">
                        <span class="logo-icon">üíö</span>
                        <span class="logo-text">Course Health</span>
                    </a>
                </div>
                <ul class="nav-links">
                    <li><a href="/index.html" data-i18n="nav.home">–ì–ª–∞–≤–Ω–∞—è</a></li>
                    <li><a href="/courses.html" data-i18n="nav.courses">–ö—É—Ä—Å—ã</a></li>
                    <li><a href="/promotions.html" data-i18n="nav.promotions">–ê–∫—Ü–∏–∏</a></li>
                    <li><a href="/about.html" data-i18n="nav.about">–û –Ω–∞—Å</a></li>
                </ul>
                <div class="nav-actions">
                    <div class="language-switcher">
                        <button class="language-button" id="languageButton" aria-label="–í—ã–±—Ä–∞—Ç—å —è–∑—ã–∫">
                            <span class="lang-icon">üá∑üá∫</span>
                        </button>
                        <div class="language-dropdown" id="languageDropdown">
                            <div class="lang-option active" data-lang="ru">
                                <span class="lang-option-flag">üá∑üá∫</span>
                                <span class="lang-option-name">–†—É—Å—Å–∫–∏–π</span>
                                <span class="lang-option-check">‚úì</span>
                            </div>
                            <div class="lang-option" data-lang="en">
                                <span class="lang-option-flag">üá¨üáß</span>
                                <span class="lang-option-name">English</span>
                                <span class="lang-option-check">‚úì</span>
                            </div>
                        </div>
                    </div>
                    <a href="/login.html" class="btn-secondary" data-i18n="header.login">–í–æ–π—Ç–∏</a>
                    <a href="/courses.html" class="btn-primary" data-i18n="header.start">–ù–∞—á–∞—Ç—å</a>
                </div>
            </nav>
        </div>
    </header>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <div class="mobile-menu-logo">
                <span class="logo-icon">üíö</span>
                <span class="logo-text">Course Health</span>
            </div>
            <button class="mobile-menu-close" id="mobileMenuClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é">‚Üê</button>
        </div>
        <ul class="mobile-menu-links">
            <li><a href="/index.html" data-i18n="nav.home">–ì–ª–∞–≤–Ω–∞—è</a></li>
            <li><a href="/courses.html" data-i18n="nav.courses">–ö—É—Ä—Å—ã</a></li>
            <li><a href="/promotions.html" data-i18n="nav.promotions">–ê–∫—Ü–∏–∏</a></li>
            <li><a href="/about.html" data-i18n="nav.about">–û –Ω–∞—Å</a></li>
            <li><a href="#" class="mobile-menu-profile" style="opacity: 0.5; pointer-events: none;" data-i18n="nav.profile">–ü—Ä–æ—Ñ–∏–ª—å</a></li>
        </ul>
    </div>

    <!-- Keto Food Hero Section -->
    <section class="course-hero" style="padding-top: 140px; padding-bottom: 80px;">
        <div class="container">
            <div class="section-header" style="text-align: center; margin-bottom: 60px;">
                <div class="section-badge" style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 20px; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 50px; margin-bottom: 20px;">
                    <span style="font-size: 20px;">üçΩÔ∏è</span>
                    <span style="color: var(--accent-gold); font-weight: 600;" data-i18n="ketoFoodPage.badge">–ö–µ—Ç–æ-—Ä–µ—Ü–µ–ø—Ç—ã</span>
                </div>
                <h1 class="section-title" style="font-size: 48px; margin-bottom: 20px;">
                    <span data-i18n="ketoFoodPage.title">100 –ª—É—á—à–∏—Ö –∫–µ—Ç–æ-—Ä–µ—Ü–µ–ø—Ç–æ–≤</span>
                </h1>
                <p class="section-description" style="font-size: 18px; max-width: 700px; margin: 0 auto; color: var(--text-gray);" data-i18n="ketoFoodPage.description">
                    –û—Ç –∑–∞–≤—Ç—Ä–∞–∫–∞ –¥–æ —É–∂–∏–Ω–∞. –í–∫—É—Å–Ω—ã–µ –∏ –ø–æ–ª–µ–∑–Ω—ã–µ –±–ª—é–¥–∞ –¥–ª—è –∫–µ—Ç–æ-–¥–∏–µ—Ç—ã
                </p>
            </div>
        </div>
    </section>

    <!-- Food Categories Navigation -->
    <section class="section" style="padding-top: 0;">
        <div class="container">
            <div class="food-categories-nav">
                <button class="food-category-btn active" data-category="breakfast">
                    <span class="category-icon">üåÖ</span>
                    <span class="category-name" data-i18n="ketoFoodPage.breakfast">–ó–∞–≤—Ç—Ä–∞–∫</span>
                </button>
                <button class="food-category-btn" data-category="lunch">
                    <span class="category-icon">üçΩÔ∏è</span>
                    <span class="category-name" data-i18n="ketoFoodPage.lunch">–û–±–µ–¥</span>
                </button>
                <button class="food-category-btn" data-category="dinner">
                    <span class="category-icon">üåô</span>
                    <span class="category-name" data-i18n="ketoFoodPage.dinner">–£–∂–∏–Ω</span>
                </button>
                <button class="food-category-btn" data-category="snacks">
                    <span class="category-icon">ü•ú</span>
                    <span class="category-name" data-i18n="ketoFoodPage.snacks">–ü–µ—Ä–µ–∫—É—Å—ã</span>
                </button>
                <button class="food-category-btn" data-category="desserts">
                    <span class="category-icon">üç∞</span>
                    <span class="category-name" data-i18n="ketoFoodPage.desserts">–î–µ—Å–µ—Ä—Ç—ã</span>
                </button>
            </div>
        </div>
    </section>

    <!-- Food Items Section -->
    <section class="section" style="padding-top: 40px;">
        <div class="container">
            <!-- Breakfast Section -->
            <div class="food-category-section active" id="breakfast">
                <div class="section-header" style="margin-bottom: 40px;">
                    <h2 class="section-title" style="font-size: 36px;">
                        <span class="gradient-text" data-i18n="ketoFoodPage.breakfast">–ó–∞–≤—Ç—Ä–∞–∫</span>
                    </h2>
                    <p class="section-description" style="color: var(--text-gray);" data-i18n="ketoFoodPage.breakfastDesc">
                        –ù–∞—á–Ω–∏—Ç–µ –¥–µ–Ω—å —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∫–µ—Ç–æ-–∑–∞–≤—Ç—Ä–∞–∫–∞
                    </p>
                </div>
                <div class="food-items-grid" id="breakfastItems">
                    <!-- Rendered by script -->
                </div>
            </div>

            <!-- Lunch Section -->
            <div class="food-category-section" id="lunch">
                <div class="section-header" style="margin-bottom: 40px;">
                    <h2 class="section-title" style="font-size: 36px;">
                        <span class="gradient-text" data-i18n="ketoFoodPage.lunch">–û–±–µ–¥</span>
                    </h2>
                    <p class="section-description" style="color: var(--text-gray);" data-i18n="ketoFoodPage.lunchDesc">
                        –°—ã—Ç–Ω—ã–µ –∏ –ø–æ–ª–µ–∑–Ω—ã–µ –∫–µ—Ç–æ-–æ–±–µ–¥—ã
                    </p>
                </div>
                <div class="food-items-grid" id="lunchItems">
                    <!-- Rendered by script -->
                </div>
            </div>

            <!-- Dinner Section -->
            <div class="food-category-section" id="dinner">
                <div class="section-header" style="margin-bottom: 40px;">
                    <h2 class="section-title" style="font-size: 36px;">
                        <span class="gradient-text" data-i18n="ketoFoodPage.dinner">–£–∂–∏–Ω</span>
                    </h2>
                    <p class="section-description" style="color: var(--text-gray);" data-i18n="ketoFoodPage.dinnerDesc">
                        –õ–µ–≥–∫–∏–µ –∏ –≤–∫—É—Å–Ω—ã–µ –∫–µ—Ç–æ-—É–∂–∏–Ω—ã
                    </p>
                </div>
                <div class="food-items-grid" id="dinnerItems">
                    <!-- Rendered by script -->
                </div>
            </div>

            <!-- Snacks Section -->
            <div class="food-category-section" id="snacks">
                <div class="section-header" style="margin-bottom: 40px;">
                    <h2 class="section-title" style="font-size: 36px;">
                        <span class="gradient-text" data-i18n="ketoFoodPage.snacks">–ü–µ—Ä–µ–∫—É—Å—ã</span>
                    </h2>
                    <p class="section-description" style="color: var(--text-gray);" data-i18n="ketoFoodPage.snacksDesc">
                        –ü–æ–ª–µ–∑–Ω—ã–µ –∫–µ—Ç–æ-–ø–µ—Ä–µ–∫—É—Å—ã –º–µ–∂–¥—É –ø—Ä–∏–µ–º–∞–º–∏ –ø–∏—â–∏
                    </p>
                </div>
                <div class="food-items-grid" id="snacksItems">
                    <!-- Rendered by script -->
                </div>
            </div>

            <!-- Desserts Section -->
            <div class="food-category-section" id="desserts">
                <div class="section-header" style="margin-bottom: 40px;">
                    <h2 class="section-title" style="font-size: 36px;">
                        <span class="gradient-text" data-i18n="ketoFoodPage.desserts">–î–µ—Å–µ—Ä—Ç—ã</span>
                    </h2>
                    <p class="section-description" style="color: var(--text-gray);" data-i18n="ketoFoodPage.dessertsDesc">
                        –°–ª–∞–¥–∫–∏–µ –∫–µ—Ç–æ-–¥–µ—Å–µ—Ä—Ç—ã –±–µ–∑ —Å–∞—Ö–∞—Ä–∞
                    </p>
                </div>
                <div class="food-items-grid" id="dessertsItems">
                    <!-- Rendered by script -->
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="logo">
                        <span class="logo-icon">üíö</span>
                        <span class="logo-text">Course Health</span>
                    </div>
                    <p class="footer-description" data-i18n="footer.description">
                        –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã –ø–æ –∫–µ—Ç–æ-–¥–∏–µ—Ç–µ –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–º—É –≥–æ–ª–æ–¥–∞–Ω–∏—é –æ—Ç –ª—É—á—à–∏—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤
                    </p>
                </div>
                <div class="footer-section">
                    <h4 data-i18n="footer.navigation">–ù–∞–≤–∏–≥–∞—Ü–∏—è</h4>
                    <ul>
                        <li><a href="/index.html" data-i18n="nav.home">–ì–ª–∞–≤–Ω–∞—è</a></li>
                        <li><a href="/courses.html" data-i18n="nav.courses">–ö—É—Ä—Å—ã</a></li>
                        <li><a href="/promotions.html" data-i18n="nav.promotions">–ê–∫—Ü–∏–∏</a></li>
                        <li><a href="/about.html" data-i18n="nav.about">–û –Ω–∞—Å</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4 data-i18n="footer.contacts">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h4>
                    <ul>
                        <li><a href="mailto:info@coursesport.ru">info@coursesport.ru</a></li>
                        <li><a href="tel:+79991234567">+7 (999) 123-45-67</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Course Health. <span data-i18n="footer.rights">–í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</span></p>
            </div>
        </div>
    </footer>

    <!-- PDF Progress Modal -->
    <div class="pdf-modal-overlay" id="pdfModal" aria-hidden="true">
        <div class="pdf-modal" role="dialog" aria-modal="true" aria-labelledby="pdfModalTitle">
            <div class="pdf-modal-header">
                <div class="pdf-modal-title" id="pdfModalTitle">PDF</div>
                <div class="pdf-modal-percent" id="pdfModalPercent">0%</div>
            </div>
            <div class="pdf-modal-subtitle" id="pdfModalSubtitle"></div>
            <div class="pdf-modal-progress">
                <div class="pdf-modal-progress-bar" id="pdfModalProgressBar" style="width:0%"></div>
            </div>
            <div class="pdf-modal-actions">
                <button class="pdf-modal-cancel" id="pdfModalCancel" type="button">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- Recipe Modal -->
    <div class="recipe-modal-overlay" id="recipeModal" aria-hidden="true">
        <div class="recipe-modal" role="dialog" aria-modal="true" aria-labelledby="recipeModalTitle">
            <div class="recipe-modal-header">
                <div class="recipe-modal-title" id="recipeModalTitle"></div>
                <button class="recipe-modal-close" id="recipeModalClose" type="button" aria-label="Close">√ó</button>
            </div>
            <div class="recipe-modal-meta" id="recipeModalMeta"></div>
            <div class="recipe-modal-body">
                <div class="recipe-modal-col">
                    <div class="recipe-modal-section-title" id="recipeModalIngredientsTitle"></div>
                    <ul class="recipe-modal-ingredients" id="recipeModalIngredients"></ul>
                </div>
                <div class="recipe-modal-col">
                    <div class="recipe-modal-section-title" id="recipeModalStepsTitle"></div>
                    <ol class="recipe-modal-steps" id="recipeModalSteps"></ol>
                </div>
            </div>
            <div class="recipe-modal-actions">
                <button class="recipe-modal-action" id="recipeModalActionClose" type="button"></button>
            </div>
        </div>
    </div>

    <script src="/js/main.js"></script>
    <script>
        // Food Categories Navigation
        const categoryButtons = document.querySelectorAll('.food-category-btn');
        const categorySections = document.querySelectorAll('.food-category-section');

        categoryButtons.forEach(button => {
            button.addEventListener('click', () => {
                const category = button.getAttribute('data-category');
                
                // Remove active class from all buttons and sections
                categoryButtons.forEach(btn => btn.classList.remove('active'));
                categorySections.forEach(section => section.classList.remove('active'));
                
                // Add active class to clicked button and corresponding section
                button.classList.add('active');
                const targetSection = document.getElementById(category);
                if (targetSection) {
                    targetSection.classList.add('active');
                    // Smooth scroll to section
                    targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });

        // ---- Keto recipes rendering (3 per category + servings scaler) ----
        const servingsById = {};
        let activePdfJobId = 0;
        let activeRecipeModal = null; // { id: string, servings: number }

        function getCurrentLang() {
            if (window.languageSwitcher?.getCurrentLanguage) return window.languageSwitcher.getCurrentLanguage();
            return localStorage.getItem('language') || 'ru';
        }

        function clampInt(n, min, max) {
            return Math.max(min, Math.min(max, n));
        }

        function formatAmount(amount) {
            const rounded = Math.round(amount * 1000) / 1000;
            const fracMap = [
                { v: 0.25, s: "¬º" },
                { v: 0.5, s: "¬Ω" },
                { v: 0.75, s: "¬æ" },
                { v: 0.33, s: "‚Öì" },
                { v: 0.67, s: "‚Öî" }
            ];

            const sign = rounded < 0 ? "-" : "";
            const abs = Math.abs(rounded);

            const intPart = Math.floor(abs);
            const fracPart = abs - intPart;

            for (const f of fracMap) {
                if (Math.abs(fracPart - f.v) < 0.03) {
                    return sign + (intPart ? `${intPart} ${f.s}` : f.s);
                }
            }

            if (Math.abs(rounded - Math.round(rounded)) < 0.0001) return String(Math.round(rounded));
            if (abs < 10) return sign + (Math.round(abs * 10) / 10).toString();
            return sign + (Math.round(abs * 1) / 1).toString();
        }

        function makeRecipeCard(recipe, lang) {
            const ui = translations?.[lang]?.ketoFoodRecipesUI || translations?.ru?.ketoFoodRecipesUI;
            const servings = servingsById[recipe.id] || 1;

            const card = document.createElement('div');
            card.className = 'food-item-card recipe-card';
            card.dataset.recipeId = recipe.id;
            card.dataset.slug = recipe.slug;

            card.innerHTML = `
                <div class="food-item-image recipe-image">
                    <img class="recipe-photo" alt="${recipe.name}" loading="lazy" />
                    <div class="recipe-image-gradient"></div>
                    <div class="recipe-badge-free">${ui.free}</div>
                    <div class="recipe-image-content">
                        <div class="recipe-image-title">${recipe.name}</div>
                    </div>
                </div>
                <div class="food-item-content recipe-content">
                    <div class="recipe-top">
                        <div class="food-item-title recipe-title">${recipe.name}</div>
                        <div class="recipe-servings">
                            <span class="recipe-servings-label">${ui.servings}</span>
                            <div class="recipe-servings-controls" role="group" aria-label="servings">
                                <button class="recipe-servings-btn" data-action="dec" aria-label="decrease">‚àí</button>
                                <span class="recipe-servings-value">${servings}</span>
                                <button class="recipe-servings-btn" data-action="inc" aria-label="increase">+</button>
                            </div>
                            <button class="recipe-pdf-btn" data-action="pdf" type="button">${ui.downloadPdf}</button>
                            <button class="recipe-view-btn" data-action="view" type="button">${ui.viewRecipe}</button>
                        </div>
                    </div>
                    <div class="recipe-ingredients">
                        <div class="recipe-ingredients-header">
                            <span class="recipe-ingredients-title">${ui.ingredients}</span>
                            <span class="recipe-ingredients-badge">√ó${servings}</span>
                        </div>
                        <ul class="recipe-ingredients-list"></ul>
                    </div>
                </div>
            `;

            updateRecipeIngredients(card, recipe, servings);
            loadRecipePhoto(card, recipe);
            attachRecipeHandlers(card, recipe, lang);
            return card;
        }

        function loadRecipePhoto(card, recipe) {
            const img = card.querySelector('.recipe-photo');
            if (!img) return;

            const slugVariants = [recipe.slug];
            // Handle common typo: omelet -> omlet
            if (recipe.slug.includes('omelet')) slugVariants.push(recipe.slug.replace('omelet', 'omlet'));

            const exts = ['jpg', 'jpeg', 'png', 'webp'];
            const candidates = [];
            slugVariants.forEach((slug) => {
                exts.forEach((ext) => {
                    candidates.push(`/img/recipes/${slug}.${ext}`);
                });
            });

            let idx = 0;
            const tryNext = () => {
                if (idx >= candidates.length) {
                    img.removeAttribute('src');
                    card.classList.remove('has-photo');
                    return;
                }
                const src = candidates[idx++];
                img.src = src;
            };

            img.onload = () => {
                card.classList.add('has-photo');
            };
            img.onerror = () => {
                tryNext();
            };

            tryNext();
        }

        function updateRecipeIngredients(card, recipe, servings) {
            const list = card.querySelector('.recipe-ingredients-list');
            const badge = card.querySelector('.recipe-ingredients-badge');
            const valueEl = card.querySelector('.recipe-servings-value');
            if (!list || !badge || !valueEl) return;

            list.innerHTML = recipe.ingredients.map((ing) => {
                const scaled = ing.amount * servings;
                const amountText = formatAmount(scaled);
                const unitText = ing.unit ? ` ${ing.unit}` : '';
                return `
                    <li class="recipe-ingredient">
                        <span class="recipe-ingredient-name">${ing.name}</span>
                        <span class="recipe-ingredient-qty">${amountText}${unitText}</span>
                    </li>
                `;
            }).join('');

            badge.textContent = `√ó${servings}`;
            valueEl.textContent = String(servings);
        }

        function attachRecipeHandlers(card, recipe, lang) {
            const controls = card.querySelector('.recipe-servings-controls');
            if (!controls) return;

            controls.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-action]');
                if (!btn) return;

                const action = btn.getAttribute('data-action');
                const current = servingsById[recipe.id] || 1;
                const next = clampInt(action === 'inc' ? current + 1 : current - 1, 1, 20);
                servingsById[recipe.id] = next;
                updateRecipeIngredients(card, recipe, next);
            });

            const pdfBtn = card.querySelector('button[data-action="pdf"]');
            if (pdfBtn) {
                pdfBtn.addEventListener('click', () => {
                    const currentServings = servingsById[recipe.id] || 1;
                    generateRecipePdfWithProgress(recipe, lang, currentServings);
                });
            }

            const viewBtn = card.querySelector('button[data-action="view"]');
            if (viewBtn) {
                viewBtn.addEventListener('click', () => {
                    const currentServings = servingsById[recipe.id] || 1;
                    openRecipeModal(recipe.id, currentServings);
                });
            }
        }

        // ---- Real PDF generation with progress modal (jsPDF + html2canvas) ----
        const pdfModal = document.getElementById('pdfModal');
        const pdfModalTitle = document.getElementById('pdfModalTitle');
        const pdfModalSubtitle = document.getElementById('pdfModalSubtitle');
        const pdfModalPercent = document.getElementById('pdfModalPercent');
        const pdfModalProgressBar = document.getElementById('pdfModalProgressBar');
        const pdfModalCancel = document.getElementById('pdfModalCancel');

        function getUi(lang) {
            return translations?.[lang]?.ketoFoodRecipesUI || translations?.ru?.ketoFoodRecipesUI;
        }

        // ---- Recipe modal logic ----
        const recipeModal = document.getElementById('recipeModal');
        const recipeModalTitle = document.getElementById('recipeModalTitle');
        const recipeModalMeta = document.getElementById('recipeModalMeta');
        const recipeModalIngredientsTitle = document.getElementById('recipeModalIngredientsTitle');
        const recipeModalIngredients = document.getElementById('recipeModalIngredients');
        const recipeModalStepsTitle = document.getElementById('recipeModalStepsTitle');
        const recipeModalSteps = document.getElementById('recipeModalSteps');
        const recipeModalClose = document.getElementById('recipeModalClose');
        const recipeModalActionClose = document.getElementById('recipeModalActionClose');

        function findRecipeById(lang, id) {
            const data = translations?.[lang]?.ketoRecipes || translations?.ru?.ketoRecipes;
            if (!data) return null;
            const all = []
                .concat(data.breakfast || [])
                .concat(data.lunch || [])
                .concat(data.dinner || [])
                .concat(data.snacks || [])
                .concat(data.desserts || []);
            return all.find(r => r.id === id) || null;
        }

        function showRecipeModal() {
            recipeModal.classList.add('active');
            recipeModal.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        }

        function hideRecipeModal() {
            recipeModal.classList.remove('active');
            recipeModal.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
            activeRecipeModal = null;
        }

        function renderRecipeModal() {
            if (!activeRecipeModal) return;
            const lang = getCurrentLang();
            const ui = getUi(lang);
            const recipe = findRecipeById(lang, activeRecipeModal.id);
            if (!recipe) return;

            const servings = activeRecipeModal.servings;
            recipeModalTitle.textContent = recipe.name;
            recipeModalMeta.innerHTML = `
                <span class="recipe-modal-badge">${ui.modalRecipeTitle}</span>
                <span class="recipe-modal-meta-item">${ui.servings}: <strong>${servings}</strong></span>
            `;

            recipeModalIngredientsTitle.textContent = ui.ingredients;
            recipeModalStepsTitle.textContent = ui.modalSteps;
            recipeModalActionClose.textContent = ui.modalClose;

            recipeModalIngredients.innerHTML = recipe.ingredients.map((ing) => {
                const scaled = ing.amount * servings;
                const amountText = formatAmount(scaled);
                const unitText = ing.unit ? ` ${ing.unit}` : '';
                return `
                    <li class="recipe-modal-ingredient">
                        <span class="recipe-modal-ingredient-name">${ing.name}</span>
                        <span class="recipe-modal-ingredient-qty">${amountText}${unitText}</span>
                    </li>
                `;
            }).join('');

            const steps = Array.isArray(recipe.steps) ? recipe.steps : [];
            recipeModalSteps.innerHTML = steps.map((s) => `<li>${s}</li>`).join('');
        }

        function openRecipeModal(recipeId, servings) {
            activeRecipeModal = { id: recipeId, servings };
            renderRecipeModal();
            showRecipeModal();
        }

        recipeModalClose?.addEventListener('click', hideRecipeModal);
        recipeModalActionClose?.addEventListener('click', hideRecipeModal);
        recipeModal?.addEventListener('click', (e) => {
            if (e.target === recipeModal) hideRecipeModal();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && recipeModal.classList.contains('active')) hideRecipeModal();
        });

        function showPdfModal(lang) {
            const ui = getUi(lang);
            pdfModalTitle.textContent = ui.pdfModalTitle;
            pdfModalCancel.textContent = ui.pdfCancel;
            setPdfProgress(0, ui.pdfPreparing);
            pdfModal.classList.add('active');
            pdfModal.setAttribute('aria-hidden', 'false');
        }

        function hidePdfModal() {
            pdfModal.classList.remove('active');
            pdfModal.setAttribute('aria-hidden', 'true');
        }

        function setPdfProgress(percent, subtitle) {
            const p = clampInt(percent, 0, 100);
            pdfModalPercent.textContent = `${p}%`;
            pdfModalProgressBar.style.width = `${p}%`;
            if (typeof subtitle === 'string') pdfModalSubtitle.textContent = subtitle;
        }

        function loadScriptOnce(src, globalCheck) {
            return new Promise((resolve, reject) => {
                if (globalCheck()) return resolve();
                const existing = document.querySelector(`script[data-src="${src}"]`);
                if (existing) {
                    existing.addEventListener('load', () => resolve());
                    existing.addEventListener('error', () => reject(new Error('Failed to load script')));
                    return;
                }
                const s = document.createElement('script');
                s.src = src;
                s.async = true;
                s.defer = true;
                s.dataset.src = src;
                s.onload = () => resolve();
                s.onerror = () => reject(new Error('Failed to load script'));
                document.head.appendChild(s);
            });
        }

        function ensurePdfLibs(lang) {
            const ui = getUi(lang);
            setPdfProgress(10, ui.pdfLoadingLibs);
            return loadScriptOnce(
                'https://cdn.jsdelivr.net/npm/jspdf@3.0.2/dist/jspdf.umd.min.js',
                () => !!(window.jspdf && window.jspdf.jsPDF)
            ).then(() => {
                setPdfProgress(20, ui.pdfLoadingLibs);
                return loadScriptOnce(
                    'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js',
                    () => typeof window.html2canvas === 'function'
                );
            });
        }

        function buildPdfDom(recipe, lang, servings) {
            const ui = getUi(lang);

            const root = document.createElement('div');
            root.className = 'pdf-render-root';
            root.innerHTML = `
                <div class="pdf-sheet">
                    <div class="pdf-head">
                        <div>
                            <div class="pdf-brand">Course Health</div>
                            <div class="pdf-title">${recipe.name}</div>
                            <div class="pdf-meta">
                                <div>${ui.servings}: <strong>${servings}</strong></div>
                            </div>
                        </div>
                        <div class="pdf-badge">${ui.free}</div>
                    </div>
                    <div class="pdf-card">
                        <div class="pdf-card-title">${ui.ingredients}</div>
                        <div class="pdf-table">
                            ${recipe.ingredients.map((ing) => {
                                const scaled = ing.amount * servings;
                                const amountText = formatAmount(scaled);
                                const unitText = ing.unit ? ` ${ing.unit}` : '';
                                return `
                                    <div class="pdf-row">
                                        <div class="pdf-cell-name">${ing.name}</div>
                                        <div class="pdf-cell-qty">${amountText}${unitText}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="pdf-foot">${recipe.slug}.pdf</div>
                    </div>
                </div>
            `;
            document.body.appendChild(root);
            return root;
        }

        function cleanupPdfDom(node) {
            if (node && node.parentNode) node.parentNode.removeChild(node);
        }

        async function generateRecipePdfWithProgress(recipe, lang, servings) {
            const ui = getUi(lang);
            const myJobId = ++activePdfJobId;
            let pdfDom = null;

            const cancel = () => {
                if (myJobId === activePdfJobId) {
                    activePdfJobId++;
                    hidePdfModal();
                }
            };

            pdfModalCancel.onclick = cancel;
            showPdfModal(lang);

            try {
                await ensurePdfLibs(lang);
                if (myJobId !== activePdfJobId) return;

                setPdfProgress(35, ui.pdfRendering);
                pdfDom = buildPdfDom(recipe, lang, servings);

                // Let layout settle
                await new Promise((r) => requestAnimationFrame(() => requestAnimationFrame(r)));
                if (myJobId !== activePdfJobId) return;

                setPdfProgress(55, ui.pdfRendering);
                const canvas = await window.html2canvas(pdfDom.querySelector('.pdf-sheet'), {
                    backgroundColor: '#0b0b0f',
                    scale: 2,
                    useCORS: true
                });
                if (myJobId !== activePdfJobId) return;

                setPdfProgress(75, ui.pdfBuilding);
                const imgData = canvas.toDataURL('image/png');

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ unit: 'pt', format: 'a4' });
                const pageW = doc.internal.pageSize.getWidth();
                const pageH = doc.internal.pageSize.getHeight();

                // Fit image into A4
                const imgW = canvas.width;
                const imgH = canvas.height;
                const ratio = Math.min(pageW / imgW, pageH / imgH);
                const drawW = imgW * ratio;
                const drawH = imgH * ratio;
                const x = (pageW - drawW) / 2;
                const y = (pageH - drawH) / 2;
                doc.addImage(imgData, 'PNG', x, y, drawW, drawH, undefined, 'FAST');

                setPdfProgress(90, ui.pdfSaving);
                const filename = `${recipe.slug}-x${servings}.pdf`;
                doc.save(filename);

                setPdfProgress(100, ui.pdfDone);
                setTimeout(() => {
                    if (myJobId === activePdfJobId) hidePdfModal();
                }, 650);
            } catch (e) {
                setPdfProgress(100, ui.pdfError);
                setTimeout(() => hidePdfModal(), 1400);
            } finally {
                cleanupPdfDom(pdfDom);
                if (myJobId === activePdfJobId) pdfModalCancel.onclick = null;
            }
        }

        function renderAllRecipes() {
            const lang = getCurrentLang();
            const data = translations?.[lang]?.ketoRecipes || translations?.ru?.ketoRecipes;
            if (!data) return;

            const map = {
                breakfast: document.getElementById('breakfastItems'),
                lunch: document.getElementById('lunchItems'),
                dinner: document.getElementById('dinnerItems'),
                snacks: document.getElementById('snacksItems'),
                desserts: document.getElementById('dessertsItems')
            };

            Object.keys(map).forEach((key) => {
                const container = map[key];
                if (!container) return;
                container.innerHTML = '';

                const recipes = data[key] || [];
                recipes.slice(0, 3).forEach((recipe) => {
                    if (!servingsById[recipe.id]) servingsById[recipe.id] = 1;
                    container.appendChild(makeRecipeCard(recipe, lang));
                });
            });
        }

        document.addEventListener('languageChanged', () => {
            renderAllRecipes();
            if (recipeModal.classList.contains('active')) {
                renderRecipeModal();
            }
        });

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', renderAllRecipes);
        } else {
            renderAllRecipes();
        }
    </script>
</body>
</html>

